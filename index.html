<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Calligraphie AR - Meta Quest</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script>
      // 1. COMPOSANT : Forceur de Passthrough (AR)
      AFRAME.registerComponent('force-ar', {
        init: function () {
          this.el.sceneEl.addEventListener('enter-vr', () => {
            document.body.style.background = "transparent";
            this.el.sceneEl.renderer.setClearAlpha(0);
            this.el.sceneEl.renderer.setClearColor('#000000', 0);
            if (document.querySelector('a-sky')) {
              document.querySelector('a-sky').setAttribute('visible', false);
            }
          });
        }
      });

      // 2. COMPOSANT : Saisie avec rotation corrigée (Pointe vers le bas)
      AFRAME.registerComponent('grab-pinceau', {
        init: function () {
          this.pinceau = document.querySelector('#pinceau-model');
          this.hand = this.el;
          this.isGrabbed = false;
          
          this.el.addEventListener('triggerdown', () => {
            let handPos = new THREE.Vector3();
            this.hand.object3D.getWorldPosition(handPos);
            let pinceauPos = new THREE.Vector3();
            this.pinceau.object3D.getWorldPosition(pinceauPos);

            if (!this.isGrabbed && handPos.distanceTo(pinceauPos) < 0.5) {
              this.isGrabbed = true;
            } else if (this.isGrabbed) {
              this.isGrabbed = false;
              // Repose le pinceau à plat sur la table
              this.pinceau.setAttribute('position', '0.3 0.05 0.1');
              this.pinceau.setAttribute('rotation', '0 0 90'); // Couché sur le côté
            }
          });
        },
        tick: function () {
          if (this.isGrabbed) {
            let handObj = this.hand.object3D;
            // On suit la main
            this.pinceau.object3D.position.copy(handObj.position);
            this.pinceau.object3D.rotation.copy(handObj.rotation);
            
            // --- CORRECTION DE L'ORIENTATION ---
            // 1. On avance le pinceau devant la main
            this.pinceau.object3D.translateZ(-0.15); 
            // 2. On le fait pivoter pour que la pointe regarde le sol
            // On teste ici une rotation de 180° (Math.PI) sur l'axe X pour le retourner
            this.pinceau.object3D.rotateX(Math.PI); 
          }
        }
      });

      // 3. COMPOSANT : Tracé (Toujours actif)
      AFRAME.registerComponent('trace-ink', {
        tick: function () {
          let pinceau = document.querySelector('#pinceau-model');
          let papier = document.querySelector('#papier');
          if (!pinceau || !papier) return;

          let tipPos = new THREE.Vector3();
          pinceau.object3D.getWorldPosition(tipPos);
          let papierPos = new THREE.Vector3();
          papier.object3D.getWorldPosition(papierPos);

          let distVerticale = Math.abs(tipPos.y - papierPos.y);
          if (distVerticale < 0.04 && tipPos.distanceTo(papierPos) < 0.4) {
            let trace = document.createElement('a-circle');
            trace.setAttribute('radius', '0.008');
            trace.setAttribute('color', '#1a1a1a');
            trace.setAttribute('rotation', '-90 0 0');
            trace.setAttribute('material', 'shader: flat');
            trace.setAttribute('position', {x: tipPos.x, y: papierPos.y + 0.002, z: tipPos.z});
            this.el.sceneEl.appendChild(trace);
          }
        }
      });
    </script>
  </head>
  <body style="background: transparent;">

    <a-scene 
      force-ar 
      trace-ink
      renderer="alpha: true; colorManagement: true;"
      webxr="optionalFeatures: passthrough, local-floor; referenceSpaceType: local-floor">

      <a-assets>
        <a-asset-item id="pinceau-glb" src="pinceau.glb"></a-asset-item>
        <a-asset-item id="pavillon-glb" src="pavillon.glb"></a-asset-item>
      </a-assets>

      <a-entity gltf-model="#pavillon-glb" position="0 1.636 -0.536" scale="3.191 3.120 3.338"></a-entity>

      <a-entity id="table-group" position="0 0.734 -0.434">
        <a-box id="table" width="1" height="0.05" depth="0.6" color="#3d2b1f">
            <a-plane id="papier" position="0 0.03 0" rotation="-90 0 0" width="0.4" height="0.5" color="#fffaf0">
                <a-text value="永" color="#ccc" align="center" width="2" position="0 0 0.01"></a-text>
            </a-plane>
        </a-box>
        
        <a-entity id="pinceau-model" 
                  gltf-model="#pinceau-glb" 
                  position="0.3 0.08 0.1" 
                  rotation="0 0 90" 
                  scale="0.3 0.3 0.3">
        </a-entity>
      </a-entity>

      <a-entity oculus-touch-controls="hand: right" grab-pinceau></a-entity>
      <a-entity oculus-touch-controls="hand: left"></a-entity>

      <a-entity camera look-controls position="0 1.6 0"></a-entity>
      
    </a-scene>
  </body>
</html>
