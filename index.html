<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Calligraphie MR - MVP Final Stable</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script>
      // 1. GESTION DES MODES (VR vs AR)
      AFRAME.registerComponent('mode-manager', {
        init: function () {
          const sceneEl = this.el;
          const sky = document.querySelector('a-sky');
          sceneEl.addEventListener('enter-vr', () => {
            if (sceneEl.is('ar-mode')) {
              sky.setAttribute('visible', 'false');
              sceneEl.renderer.setClearColor('#000000', 0);
            } else {
              sky.setAttribute('visible', 'true');
            }
          });
          sceneEl.addEventListener('exit-vr', () => { sky.setAttribute('visible', 'true'); });
        }
      });

      // 2. SYSTÈME DE TRACÉ PRÉCIS (Correction Axe Y + Sensibilité)
      AFRAME.registerComponent('trace-ink', {
        tick: function () {
          let pinceau = document.querySelector('#pinceau-model');
          let papier = document.querySelector('#papier');
          if (!pinceau || !papier) return;

          let tipPos = new THREE.Vector3();
          pinceau.object3D.getWorldPosition(tipPos);
          
          // CALCUL DE L'OFFSET
          let direction = new THREE.Vector3(0, 1, 0); 
          direction.applyQuaternion(pinceau.object3D.quaternion);
          tipPos.addScaledVector(direction, 0.15); 

          let papierPos = new THREE.Vector3();
          papier.object3D.getWorldPosition(papierPos);

          let distanceVerticale = tipPos.y - papierPos.y;
          let distCentrale = new THREE.Vector2(tipPos.x - papierPos.x, tipPos.z - papierPos.z).length();

          // DÉTECTION FINE
          if (distanceVerticale < 0.03 && distanceVerticale > -0.01 && distCentrale < 0.3) {
            let trace = document.createElement('a-circle');
            let randomSize = 0.006 + (Math.random() * 0.004);
            trace.setAttribute('class', 'ink-trace');
            trace.setAttribute('radius', randomSize);
            trace.setAttribute('color', '#1a1a1a');
            trace.setAttribute('material', 'shader: flat; transparent: true; opacity: 0.9');
            trace.setAttribute('rotation', '-90 0 0');
            trace.setAttribute('position', {x: tipPos.x, y: papierPos.y + 0.002, z: tipPos.z});
            this.el.sceneEl.appendChild(trace);
          }

          // DÉTECTION DU BOUTON EFFACER
          let bouton = document.querySelector('#bouton-effacer');
          let boutonPos = new THREE.Vector3();
          bouton.object3D.getWorldPosition(boutonPos);
          if (tipPos.distanceTo(boutonPos) < 0.06) {
             this.clearPaper();
          }
        },
        clearPaper: function() {
          const traces = document.querySelectorAll('.ink-trace');
          traces.forEach(t => t.parentNode.removeChild(t));
        }
      });

      // 3. ATTACHER LE PINCEAU (Correction Rotation Inversée et Prise en main)
      AFRAME.registerComponent('controller-grab', {
        init: function () {
          this.pinceau = document.querySelector('#pinceau-model');
          this.isGrabbed = false;
          this.el.addEventListener('triggerdown', () => { this.isGrabbed = !this.isGrabbed; });
        },
        tick: function () {
          if (this.isGrabbed) {
            let handPos = new THREE.Vector3();
            let handQuat = new THREE.Quaternion();
            this.el.object3D.getWorldPosition(handPos);
            this.el.object3D.getWorldQuaternion(handQuat);
            
            // On aligne la position du pinceau sur la manette
            this.pinceau.object3D.position.copy(handPos);
            
            // Correction de la rotation miroir : on applique le quaternion de la main
            this.pinceau.object3D.quaternion.copy(handQuat);

            // Ajustements locaux pour que le pinceau soit dans le bon sens et incliné
            this.pinceau.object3D.rotateY(Math.PI);    // Retourne le modèle pour éviter l'effet miroir
            this.pinceau.object3D.rotateX(Math.PI / 4); // Inclinaison naturelle 45°
            
            // On déplace le manche pour qu'il ne soit pas au centre de la manette
            this.pinceau.object3D.translateY(-0.15); 
          }
        }
      });
    </script>

    <style>
      .ui-overlay { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 999; display: flex; gap: 20px; }
      button { padding: 15px 25px; border-radius: 10px; border: none; background: #ceac5d; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
      button:hover { background: #b08d42; }
    </style>
  </head>

  <body>
    <div class="ui-overlay">
      <button onclick="document.querySelector('a-scene').enterVR()">MODE VR (IMMERSIF)</button>
      <button onclick="document.querySelector('a-scene').enterAR()">MODE AR (PASSTHROUGH)</button>
    </div>

    <a-scene mode-manager trace-ink renderer="alpha: true; antialias: true;" webxr="optionalFeatures: passthrough, local-floor; referenceSpaceType: local-floor">
      <a-assets>
        <a-asset-item id="pinceau-glb" src="pinceau.glb"></a-asset-item>
        <a-asset-item id="pavillon-glb" src="pavillon.glb"></a-asset-item>
        <img id="sky-texture" src="sky.jpg">
      </a-assets>

      <a-sky id="sky" src="#sky-texture"></a-sky>

      <a-entity light="type: ambient; intensity: 0.7;"></a-entity>
      <a-entity light="type: directional; intensity: 0.6;" position="1 2 1"></a-entity>

      <a-entity gltf-model="#pavillon-glb" position="0 1.6 -0.5" scale="3.1 3.1 3.1"></a-entity>

      <a-box position="0 0.734 -0.434" width="0.8" height="0.05" depth="0.5" color="#3d2b1f">
          <a-plane id="papier" position="0 0.03 0" rotation="-90 0 0" width="0.35" height="0.45" color="#fffaf0">
              <a-text value="永" color="#bbb" align="center" width="1.5" position="0 0 0.01"></a-text>
          </a-plane>
          <a-cylinder id="bouton-effacer" position="0.3 0.03 0.15" radius="0.04" height="0.02" color="#ceac5d">
              <a-text value="CLEAR" align="center" position="0 0.021 0" rotation="-90 0 0" width="0.8" color="white"></a-text>
          </a-cylinder>
      </a-box>

      <a-entity id="pinceau-model" gltf-model="#pinceau-glb" position="0.2 0.8 -0.35" rotation="0 0 90" scale="0.3 0.3 0.3"></a-entity>

      <a-entity oculus-touch-controls="hand: right" controller-grab></a-entity>
      <a-entity oculus-touch-controls="hand: left"></a-entity>

      <a-entity camera look-controls position="0 1.6 0"></a-entity>
    </a-scene>
  </body>
</html>
