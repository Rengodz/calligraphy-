<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Calligraphie AR - Quest 3 Edition</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script>
      // COMPOSANT FORCE PASSTHROUGH (Nettoyé pour Quest 3)
      AFRAME.registerComponent('ar-handler', {
        init: function () {
          this.el.addEventListener('enter-vr', () => {
            if (this.el.is('ar-mode')) {
              // On force le fond en noir avec alpha 0 pour voir le salon
              this.el.renderer.setClearColor('#000000', 0);
              // On cache le pavillon si on veut voir son vrai salon, 
              // ou on le garde si on veut un décor mixte.
              // document.querySelector('[gltf-model="#pavillon-glb"]').setAttribute('visible', 'false');
            }
          });
        }
      });

      // GESTION DU PINCEAU (Optimisée pour le mouvement)
      AFRAME.registerComponent('quest-controller-handler', {
        init: function () {
          this.pinceau = document.querySelector('#pinceau-model');
          this.isGrabbed = false;
          
          this.el.addEventListener('triggerdown', () => {
            let handPos = new THREE.Vector3();
            this.el.object3D.getWorldPosition(handPos);
            let pinceauPos = new THREE.Vector3();
            this.pinceau.object3D.getWorldPosition(pinceauPos);

            // Distance de capture (0.3m)
            if (!this.isGrabbed && handPos.distanceTo(pinceauPos) < 0.3) {
              this.isGrabbed = true;
            } else if (this.isGrabbed) {
              this.isGrabbed = false;
            }
          });
        },
        tick: function () {
          if (this.isGrabbed) {
            // Le pinceau suit la manette avec un léger offset pour simuler la prise en main
            let handWorldPos = new THREE.Vector3();
            let handWorldQuat = new THREE.Quaternion();
            this.el.object3D.getWorldPosition(handWorldPos);
            this.el.object3D.getWorldQuaternion(handWorldQuat);
            
            this.pinceau.object3D.position.copy(handWorldPos);
            this.pinceau.object3D.quaternion.copy(handWorldQuat);
            
            // Ajustement pour que le pinceau sorte "du haut" de la manette
            this.pinceau.object3D.rotateX(Math.PI / 2); 
            this.pinceau.object3D.translateY(-0.1); 
          }
        }
      });

      // SYSTÈME DE TRACÉ
      AFRAME.registerComponent('trace-ink', {
        tick: function () {
          let pinceau = document.querySelector('#pinceau-model');
          let papier = document.querySelector('#papier');
          if (!pinceau || !papier) return;

          let tipPos = new THREE.Vector3();
          // On vise le bout du pinceau
          pinceau.object3D.getWorldPosition(tipPos);
          
          let papierPos = new THREE.Vector3();
          papier.object3D.getWorldPosition(papierPos);

          let distanceVerticale = tipPos.y - papierPos.y;
          let distCentrale = new THREE.Vector2(tipPos.x - papierPos.x, tipPos.z - papierPos.z).length();

          // Détection de contact (Seuil 2cm au dessus du papier)
          if (distanceVerticale < 0.02 && distanceVerticale > -0.01 && distCentrale < 0.3) {
            let trace = document.createElement('a-circle');
            trace.setAttribute('radius', '0.006');
            trace.setAttribute('color', '#1a1a1a');
            trace.setAttribute('rotation', '-90 0 0');
            trace.setAttribute('material', 'shader: flat');
            // On pose l'encre juste au dessus du papier pour éviter le Z-fighting
            trace.setAttribute('position', {x: tipPos.x, y: papierPos.y + 0.001, z: tipPos.z});
            this.el.sceneEl.appendChild(trace);
          }
        }
      });
    </script>
  </head>
  <body>
    <a-scene 
      ar-handler
      trace-ink
      renderer="alpha: true; antialias: true; colorManagement: true;"
      webxr="optionalFeatures: passthrough, local-floor; referenceSpaceType: local-floor">

      <a-assets>
        <a-asset-item id="pinceau-glb" src="pinceau.glb"></a-asset-item>
        <a-asset-item id="pavillon-glb" src="pavillon.glb"></a-asset-item>
      </a-assets>

      <a-entity light="type: ambient; intensity: 0.8;"></a-entity>
      <a-entity light="type: directional; intensity: 0.6;" position="1 2 1"></a-entity>

      <a-entity gltf-model="#pavillon-glb" position="0 1.6 -0.5" scale="3.1 3.1 3.1"></a-entity>

      <a-box id="table" position="0 0.734 -0.434" width="0.8" height="0.05" depth="0.5" color="#3d2b1f">
          <a-plane id="papier" position="0 0.03 0" rotation="-90 0 0" width="0.35" height="0.45" color="#fffaf0">
              <a-text value="永" color="#bbb" align="center" width="1.5" position="0 0 0.01"></a-text>
          </a-plane>
      </a-box>

      <a-entity id="pinceau-model" 
                gltf-model="#pinceau-glb" 
                position="0.2 0.8 -0.35" 
                rotation="0 0 90" 
                scale="0.3 0.3 0.3">
      </a-entity>

      <a-entity oculus-touch-controls="hand: right" quest-controller-handler></a-entity>
      <a-entity oculus-touch-controls="hand: left"></a-entity>

      <a-entity camera look-controls position="0 1.6 0"></a-entity>
    </a-scene>
  </body>
</html>
