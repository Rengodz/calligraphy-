<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Calligraphie AR - Framework Power</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.150.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.150.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>
    <div id="ar-overlay" style="position:fixed; bottom:20px; width:100%; text-align:center; z-index:1000;">
        <button id="ar-button" style="padding:16px; border-radius:8px; background:#ceac5d; color:white; border:none; font-weight:bold;">
            DEMARRER L'AR (QUEST/PHONE)
        </button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

        let scene, camera, renderer, controller;
        let pinceau, papier;

        // Configuration du Loader (Anti-Freeze)
        const loader = new GLTFLoader();
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');
        loader.setDRACOLoader(dracoLoader);

        init();

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Lumières AR standard
            scene.add(new THREE.AmbientLight(0xffffff, 1));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(1, 2, 1);
            scene.add(sun);

            // Chargement sécurisé
            loader.load('pavillon.glb', (gltf) => {
                gltf.scene.position.set(0, 1.6, -0.5);
                gltf.scene.scale.set(3, 3, 3);
                scene.add(gltf.scene);
            });

            loader.load('pinceau.glb', (gltf) => {
                pinceau = gltf.scene;
                pinceau.scale.set(0.3, 0.3, 0.3);
                pinceau.visible = false;
            });

            // Bouton de lancement AR
            const btn = document.getElementById('ar-button');
            btn.addEventListener('click', () => {
                navigator.xr.requestSession('immersive-ar', { 
                    requiredFeatures: ['local-floor'],
                    optionalFeatures: ['hand-tracking'] 
                }).then(session => {
                    renderer.xr.setSession(session);
                    btn.parentElement.style.display = 'none';
                });
            });

            // Contrôleur (La main devient le pinceau)
            controller = renderer.xr.getController(0);
            controller.addEventListener('connected', () => {
                if(pinceau) {
                    controller.add(pinceau);
                    pinceau.visible = true;
                    pinceau.rotation.x = Math.PI / 2; // Aligné avec l'index
                }
            });
            scene.add(controller);

            renderer.setAnimationLoop(render);
        }

        function render() {
            if (pinceau && renderer.xr.isPresenting) {
                // Système de tracé (inchangé)
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
